---
# After a fresh install of Ubuntu 18.04,
# With all default options, and a user dorab.
# Note: May need to install drivers.

# Bootstrap.
# Create a sudoable user that will run ansible. Most likely, dorab.
# Create /etc/sudoers.d/dorab which contains
# dorab ALL=(ALL) NOPASSWD:ALL
# And is mode 600 with root.root.
# Install ansible
# sudo apt-add-repository -y ppa:ansible/ansible
# sudo apt update
# sudo apt -y install ansible

# Use vagrant reload instead of reboot on the vagrant host.

# vagrant init bento/ubuntu-18.04
# vagrant up
# vagrant ssh

# TODO: after installing with ansible
# scp -p original:~/.ssh/id_ed25519 ~/.ssh
# scp -p original:~/.aws/credentials ~/.aws
# scp -r -p original:~/.gnupg ~
# scp -r -p original:~/Projects ~
# scp -r -p original:~/Credentials/* ~

# TODO: Configure Chrome: no password saving.
# TODO: Perhaps download graphics drivers?
# TODO: make the user addition to be parameterized
# TODO: Harden sshd (maybe already OK).
# TODO: Set up default printer.
# Stop cupsd
# In /etc/cups/printers.conf
# <DefaultPrinter HP_LaserJet_600_M601_025E84>
# ...
# </DefaultPrinter>
# Restart cupsd

- hosts: all
  vars:
    clojure_version: "1.9.0.381" # until an apt package is available
    clojure_sha256: "sha256:cab9d1dbd0ecd5116d132f3d05ac917ec6168d1253d1666f5737e8f02000a492"
    favorites: "['org.gnome.Nautilus.desktop',\
    'libreoffice-writer.desktop',\
    'org.gnome.Software.desktop',\
    'firefox.desktop',\
    'google-chrome.desktop',\
    'skypeforlinux.desktop',\
    'emacs25.desktop',\
    'org.gnome.Terminal.desktop']"
    backup_excludes: "['$TRASH',\
    '$DOWNLOAD',\
    '/home/dorab/VirtualBox VMs',\
    '/home/dorab/.vagrant',\
    '/home/dorab/.vagrant.d']"
  become: true
  # gather_facts needs to be false only for the bootstrap installation of python.
  # There may be other reasons to set gather_facts to false as well.
  # Having to do with multiple playbooks.
  gather_facts: false
  pre_tasks:
    # install python only if ping fails
    - name: Try ping first to see if a python2 already exists
      ping:
      ignore_errors: true
      register: ping_reg
    - name: Bootstrap installation of python2
      raw: apt-get -y install python
      when: ping_reg is failed
    - name: Gather facts anyways
      action: setup
  tasks:
    # Keys first, then repos, then the dist-upgrade.
    - name: Add signing keys for Google chrome
      apt_key:
        url: https://dl.google.com/linux/linux_signing_key.pub
        state: present
    - name: Add repository for ansible
      apt_repository:
        repo: ppa:ansible/ansible
        state: present
    - name: Add repository for Google chrome
      apt_repository:
        repo: deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main
        filename: google-chrome
        state: present
    - name: Do a dist-upgrade
      apt:
        upgrade: dist
        update_cache: yes
    - name: Install the lastest versions of listed packages
      apt:
        name: "{{ item }}"
        state: latest
        update_cache: yes
      loop:
        - ansible
        - python-pip            # for the ansible pip module
        - python-mysqldb        # for ansible mysql module
        - dconf-tools           # for caps lock -> control
        - curl
        - whois
        - git
        - screen
        - emacs
        - keychain
        - default-jdk
        - openjdk-8-jdk         # For Clojure
        - awscli
        - virtualbox
        - virtualbox-guest-additions-iso
        - firefox               # Likely installed already
        - libreoffice           # Likely installed already
        - google-chrome-stable
    # Until Ansible has a snap module, use this.
    - name: Ensure Skype installed (not necessarily latest)
      apt:
        deb: https://go.skype.com/skypeforlinux-64.deb
        state: present          # deb only allows present
    - name: Purge installed apps
      apt:
        name: "{{ item }}"
        state: absent
        purge: yes
      loop:
        - ubuntu-web-launchers  # to remove Amazon icon from launcher
    # Too bad we cannot use the alternatives module
    # as it would require listing each java command.
    - name: Check if jdk8 is default
      command: update-alternatives --display java
      register: chkjava
      changed_when: false
    - name: Choose jdk8 as default for Clojure
      command: update-java-alternatives --set java-1.8.0-openjdk-amd64
      when: chkjava.stdout.find('link currently points to /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java') == -1
    # Deal with openjdk8 bugs on ubuntu 18.04
    - name: Check if bad cacerts file exists
      command: sha256sum /etc/ssl/certs/java/cacerts
      register: chkcacerts
      changed_when: false
    - name: Remove bad cacerts file
      file:
        path: /etc/ssl/certs/java/cacerts
        state: absent
      when: chkcacerts.stdout.find('c8f5854f9963dd3e5a5c049af0658e06954d98e7cc9c9dc607401a8435b7abc7') >= 0
    - name: Update the cacerts
      command: update-ca-certificates --fresh
      when: chkcacerts.stdout.find('c8f5854f9963dd3e5a5c049af0658e06954d98e7cc9c9dc607401a8435b7abc7') >= 0
    - name: Check latest vagrant version
      shell: >-
        curl -s https://releases.hashicorp.com/vagrant/ |
        grep '<a href="/vagrant/[0-9]*\.[0-9]*\.[0-9]*/">' |
        head -1 |
        sed -e 's|.*/vagrant/||' -e 's|/.*||'
      args:
        warn: false
      register: chkvagrantlatest
      changed_when: false
    - name: Check current vagrant version
      shell: which vagrant > /dev/null && vagrant --version | sed -e 's/Vagrant //'
      register: chkvagrantcurrent
      changed_when: false
      failed_when: chkvagrantcurrent.rc > 1
    - name: Install latest vagrant
      apt:
        deb: "https://releases.hashicorp.com/vagrant/\
        {{ chkvagrantlatest.stdout }}/vagrant_\
        {{ chkvagrantlatest.stdout }}_x86_64.deb"
      when: chkvagrantlatest.stdout != chkvagrantcurrent.stdout
    # Clean up
    - name: Remove unneeded apt stuff
      apt:
        autoremove: yes
    - name: Install python packages via pip
      pip:
        name: "{{ item }}"
        state: latest
      loop:
        - virtualenv
        - psutil                # for the dconf ansible module
    # Need this until there is an apt package for Clojure
    - name: Check current Clojure version
      shell: grep Version /usr/local/bin/clojure 2> /dev/null | sed -e 's/.*Version = //'
      args:
        warn: false
      register: chkclj
      changed_when: false
    - name: Get Clojure installer
      get_url:
        url: "https://download.clojure.org/install/linux-install-{{ clojure_version }}.sh"
        dest: "/tmp/install-{{ clojure_version }}.sh"
        mode: 0555
        checksum: "{{ clojure_sha256 }}"
      when: chkclj.stdout != clojure_version
    - name: Install Clojure
      shell: "/tmp/install-{{ clojure_version }}.sh && rm -f /tmp/install-{{ clojure_version }}.sh"
      when: chkclj.stdout != clojure_version
      args:
        removes: "/tmp/install-{{ clojure_version }}.sh"
        warn: false
    - name: Enable firewall
      ufw:
        state: enabled
    - name: Default firewall ingress rule
      ufw:
        direction: incoming
        policy: deny
    - name: Default firewall egress rule
      ufw:
        direction: outgoing
        policy: allow
    - name: Firewall ingress allow rules
      ufw:
        rule: allow
        proto: "{{ item.proto }}"
        port: "{{ item.port }}"
      loop:
        - { proto: 'tcp', port: 'ssh' }
    #########
    # Now the user-specific stuff
    - name: Ensure there is group dorab
      group:
        name: dorab
    - name: Ensure there is a user dorab
      user:
        name: dorab
        group: dorab
        # TODO: This could be dangerous if a newer OS version required
        # additional groups, and this command sets only these groups.
        groups: adm,cdrom,sudo,dip,plugdev,lpadmin,sambashare
        shell: /bin/bash
        comment: "Dorab Patel,,,"
    - name: Ensure a bin directory
      file:
        path: ~dorab/bin
        owner: dorab
        group: dorab
        state: directory
    - name: Ensure ~/.ssh
      file:
        path: ~dorab/.ssh
        owner: dorab
        group: dorab
        mode: 0700
        state: directory
    - name: Add authorized public keys
      authorized_key:
        user: dorab
        key: "{{ item }}"
      with_file:
        - files/dorab-optiplex-ed25519-20161201.pub
        - files/dorab-imac-ed25519-20161125.pub
    - name: Add ssh client config
      copy:
        src: files/sshconfig
        dest: ~dorab/.ssh/config
        owner: dorab
        group: dorab
        mode: 0600
    - name: Ensure sudo without password
      copy:
        src: files/sudoers-dorab
        dest: /etc/sudoers.d/dorab
        owner: root
        group: root
        mode: 0600
    - name: Ensure there is a .emacs.d directory
      file:
        path: ~dorab/.emacs.d
        owner: dorab
        group: dorab
        state: directory
    - name: Ensure there is an init.el in the .emacs.d directory
      copy:
        src: files/init.el
        dest: ~dorab/.emacs.d/init.el
        owner: dorab
    # TODO: Install all current emacs packages
    # emacs --batch -exec package-install-selected-packages
    - name: Set dconf settings
      dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      become: yes
      become_user: dorab
      loop:
        - { key: '/org/gnome/desktop/input-sources/xkb-options', value: "['caps:ctrl_modifier']" }
        - { key: '/org/gnome/shell/favorite-apps', value: "{{ favorites }}" }
        # TODO: Fix the password
        - { key: '/org/gnome/desktop/remote-access/vnc-password', value: "'b3B0aXBsZXg='" }
        - { key: '/org/gnome/desktop/remote-access/authentication-methods', value: "['vnc']" }
        - { key: '/org/gnome/desktop/remote-access/prompt-enabled', value: "false" }
        # Disabling encryption is required for Macs and Windows to connect.
        - { key: '/org/gnome/desktop/remote-access/require-encryption', value: "false" }
        - { key: '/org/gnome/deja-dup/backend', value: "'local'" }
        - { key: '/org/gnome/deja-dup/periodic', value: "true" }
        - { key: '/org/gnome/deja-dup/periodic-period', value: "1" }
        - { key: '/org/gnome/deja-dup/exclude-list', value: "{{ backup_excludes }}" }
        # Assumes BackupVolume has been setup earlier
        - { key: '/org/gnome/deja-dup/local/folder', value: "'/media/dorab/BackupVolume'" }
    # Assumes git is installed earlier.
    - name: Ensure my global git config
      git_config:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        scope: global
      become: yes
      become_user: dorab
      loop:
        - { key: 'user.name', value: 'Dorab Patel' }
        - { key: 'user.email', value: 'dorab@matchcraft.com' }
        - { key: 'core.editor', value: 'emacs' }
        - { key: 'push.default', value: 'simple' }
    - name: Ensure git config dir exists
      file:
        path: ~dorab/.config/git
        owner: dorab
        group: dorab
        mode: 0700
        state: directory
    - name: Ensure my global gitignore
      copy:
        src: files/global_gitignore
        dest: ~dorab/.config/git/ignore
        owner: dorab
        group: dorab
    - name: Ensure my screenrc
      copy:
        src: files/screenrc
        dest: ~dorab/.screenrc
        owner: dorab
        group: dorab
    - name: Ensure keychain is started from .profile
      blockinfile:
        dest: ~dorab/.profile
        block: |
          eval `keychain --eval --quiet --quick`
    - name: Ensure ~/.aws
      file:
        path: ~dorab/.aws
        state: directory
        mode: 0700
        owner: dorab
        group: dorab
    - name: Copy over ~/.aws/config
      copy:
        src: files/aws-config
        dest: ~dorab/.aws/config
        mode: 0600
        owner: dorab
        group: dorab
    - name: Ensure leiningen
      get_url:
        url: https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein
        dest: ~dorab/bin/lein
        mode: 0755
        owner: dorab
        group: dorab
    - name: Ensure ~/.lein
      file:
        path: ~dorab/.lein
        state: directory
        owner: dorab
        group: dorab
    - name: Copy over profiles.clj
      copy:
        src: files/profiles.clj
        dest: ~dorab/.lein/profiles.clj
        owner: dorab
        group: dorab
